# prompts.py (ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„ã€ç»“æ„åŒ–çš„ Prompt)

from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import JsonOutputParser

from data_models import SelectedTransport, PreMeetingPlanOutput


# å®šä¹‰ç”¨äºæå–ä¿¡æ¯çš„ Prompt
INPUT_EXTRACTION_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„è¡Œç¨‹è§„åˆ’åŠ©æ‰‹ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä»ç”¨æˆ·æä¾›çš„åŸå§‹æ–‡æœ¬ä¸­ï¼Œç²¾ç¡®åœ°æå–æ‰€æœ‰å…³é”®çš„è¡Œç¨‹å‚æ•°ã€‚
å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜ç¡®æä¾›æŸäº›ä¿¡æ¯ï¼Œè¯·å°½åŠ›æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­æˆ–å°†å…¶ä¿ç•™ä¸º Noneï¼ˆå¦‚æœæ¨¡å‹æ”¯æŒï¼‰ã€‚

åŸå§‹ç”¨æˆ·è¾“å…¥æ–‡æœ¬:
---
{user_input}
---

è¯·ä¸¥æ ¼æŒ‰ç…§æä¾›çš„ JSON Schema æ ¼å¼è¾“å‡ºæå–ç»“æœã€‚æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…éœ€çš„ã€‚
"""

TRANSPORT_DECISION_PROMPT = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å•†åŠ¡è¡Œç¨‹è§„åˆ’AIï¼Œä½ çš„**æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š** åœ¨æ»¡è¶³æ‰€æœ‰æ—¶é—´çº¦æŸçš„å‰æä¸‹ï¼Œé€‰æ‹©èƒ½**ä¸ºä¼šå‰è°ƒç ”æ´»åŠ¨æä¾›æœ€é•¿ç©ºé—²æ—¶é—´**çš„äº¤é€šæ–¹æ¡ˆã€‚

            --- ğŸ¯ å…³é”®çº¦æŸä¸ç›®æ ‡ ---
            1. **é¦–è¦ç›®æ ‡ï¼šè°ƒç ”æ—¶é—´æœ€å¤§åŒ–ã€‚** äº¤é€šæ–¹æ¡ˆçš„åˆ°è¾¾æ¢çº½æ—¶é—´ï¼ˆç»“åˆé€‰é¡¹ä¸­çš„"arrival_date"å’Œ"arrival_time"ï¼‰è¶Šæ—©ï¼Œå¾—åˆ†è¶Šé«˜ã€‚
            2. **ç¡¬æ€§æˆªæ­¢æ—¶é—´ï¼š** ç­æ¬¡çš„åˆ°è¾¾æ¢çº½æ—¶é—´**å¿…é¡»æ—©äº** **{latest_hub_arrival}**ã€‚ä»»ä½•æ™šäºæ­¤æ—¶é—´çš„é€‰é¡¹å‡ä¸äºˆè€ƒè™‘ã€‚

            --- â±ï¸ ç›®æ ‡æ—¶é—´ä¸é€šå‹¤ä¿¡æ¯ ---
            * ç›®æ ‡ä¼šè®®å¼€å§‹æ—¶é—´: {meeting_start_dt}
            * **ç¡¬æ€§æˆªæ­¢ï¼šæœ€æ™šæ¢çº½åˆ°è¾¾æ—¶é—´: {latest_hub_arrival}** (å·²åŒ…å«ç¼“å†²)
            * ä»å®¶åˆ°å‡ºå‘æ¢çº½éœ€ {home_commute_time} åˆ†é’Ÿã€‚
            * ä»åˆ°è¾¾æ¢çº½åˆ°ä¼šè®®åœ°éœ€ {arrival_commute_time} åˆ†é’Ÿã€‚

            --- æ‰€æœ‰äº¤é€šé€‰é¡¹ (JSON æ ¼å¼åˆ—è¡¨) ---
            {transport_options}

            --- ğŸ“ è¾“å‡ºè¦æ±‚ ---
            **æ¨ç†é€»è¾‘ï¼š** ä½ å¿…é¡»å…ˆæ ¹æ®â€œç¡¬æ€§æˆªæ­¢æ—¶é—´â€è¿‡æ»¤æ‰ä¸åˆæ ¼çš„é€‰é¡¹ã€‚ç„¶ååœ¨å‰©ä½™çš„é€‰é¡¹ä¸­ï¼Œä»¥è°ƒç ”æ—¶é—´æ½œåŠ›ï¼ˆåˆ°è¾¾æ—¶é—´æœ€æ—©ï¼‰ä¸ºä¸»è¦æŒ‡æ ‡ï¼Œç»“åˆä»·æ ¼ï¼Œé€‰å‡ºæœ€ä¼˜æ–¹æ¡ˆã€‚
            ä½ å¿…é¡»ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œ**ä»…åŒ…å«é€‰å®šç­æ¬¡çš„ 'type' å’Œ 'id'**ï¼Œä»¥åŠä½ çš„æ¨ç†ç†ç”±ã€‚å…¶ç»“æ„å¿…é¡»ä¸¥æ ¼ç¬¦åˆä»¥ä¸‹ Pydantic Model çš„å®šä¹‰:
            {format_instructions}
            """
        ),
        ("human", "è¯·æ ¹æ®ä¸Šè¿°çº¦æŸå’Œé€‰é¡¹ï¼Œé€‰æ‹©æœ€ä½³ç­æ¬¡ï¼Œå¹¶ç»™å‡ºç†ç”±ã€‚"),
    ]
).partial(format_instructions=JsonOutputParser(pydantic_object=SelectedTransport).get_format_instructions())

#ä¼ä¸šè¯„åˆ†æç¤ºè¯
EVALUATE_SCORE_PROMPT = """
è¯·æ‰®æ¼”ä¸€ä½èµ„æ·±çš„ç§‘æŠ€è¡Œä¸šæŠ•èµ„é¡¾é—®ï¼Œä½ æ­£åœ¨ä¸ºä¸€ä½é«˜ç®¡è§„åˆ’ä¸€æ¬¡å‡ºå·®å‰çš„ä¼ä¸šè°ƒç ”è¡Œç¨‹ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¼ä¸šçš„åç§°ã€è¡Œä¸šèƒŒæ™¯ä»¥åŠå…¶è¡Œç¨‹çš„æ—¶é—´æˆæœ¬ï¼Œå¯¹æ¯ä¸ªä¼ä¸šè¿›è¡Œè¯„åˆ†ï¼Œä»¥è¾…åŠ©æœ€ç»ˆçš„è¡Œç¨‹å†³ç­–ã€‚

**æ€»å¯ç”¨æ—¶é—´:** {t_available:.1f} åˆ†é’Ÿã€‚

**è¯„åˆ†ç»´åº¦ (0-10åˆ†ï¼Œ10åˆ†ä¸ºæœ€é«˜)ï¼š**
1.  **å¸å¼•åŠ›è¯„åˆ† (S_attract):** è¯„ä¼°è¯¥ä¼ä¸šåœ¨å½“å‰è¡Œä¸šä¸­çš„æˆ˜ç•¥ä»·å€¼ã€æŠ€æœ¯åˆ›æ–°æ€§ã€ä»¥åŠæ‹œè®¿çš„å¿…è¦æ€§ã€‚
2.  **å¯è¡Œæ€§è¯„åˆ† (S_feas):** è¯„ä¼°è¯¥ä¼ä¸šåœ¨åœ°ç†ä¸Šçš„å¯è¾¾æ€§ã€æ˜¯å¦ä½äºä¸»è¦ç§‘æŠ€å›­é›†ç¾¤ã€ä»¥åŠä¸å…¶ä»–ä¼ä¸š/ä¼šè®®åœ°ç‚¹é¡ºè·¯çš„ç¨‹åº¦ã€‚

**è¾“å…¥ä¼ä¸šåˆ—è¡¨ï¼š**
{companies_markdown_table}

"""


# --- 2. ä¼šè®®å‰è°ƒç ”è§„åˆ’æç¤ºè¯ (PRE_MEETING_PLAN_PROMPT) ---
PRE_MEETING_PLAN_PROMPT = ChatPromptTemplate.from_messages([
    ("system",
     "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è¡Œç¨‹è§„åˆ’ä¼˜åŒ–å™¨ã€‚ä½ çš„ç›®æ ‡æ˜¯åœ¨å•†åŠ¡äººå£«åˆ°è¾¾åŸå¸‚åã€ä¼šè®®å¼€å§‹å‰ï¼Œå®‰æ’ 1-2 ä¸ªé¡ºè·¯çš„è°ƒç ”ä¼ä¸šã€‚"
     "è°ƒç ”æ´»åŠ¨é»˜è®¤æ—¶é•¿ä¸º {visit_duration_minutes} åˆ†é’Ÿã€‚"
     "**ã€æ ¸å¿ƒçº¦æŸã€‘** æœ€ç»ˆçš„è¡Œç¨‹å¿…é¡»æ˜¯å¯è¡Œçš„ï¼š**æ‰€æœ‰æ´»åŠ¨å’Œäº¤é€šçš„æ€»æ—¶é—´ä¸èƒ½è¶…è¿‡ {available_minutes} åˆ†é’Ÿ**ã€‚"
     "ä½ çš„å†³ç­–åº”åŸºäºï¼š**è°ƒç ”ä»·å€¼ (value_score) / æ—¶é—´æˆæœ¬ (driving_time_min)** çš„æ¯”å€¼ï¼Œé€‰æ‹©æ€§ä»·æ¯”æœ€é«˜çš„ä¼ä¸šã€‚"
     "**ã€é‡è¦ã€‘ä½ å¿…é¡»åªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡**ï¼Œå…¶ç»“æ„å¿…é¡»ä¸¥æ ¼ç¬¦åˆä»¥ä¸‹ Pydantic Model çš„å®šä¹‰: \n{format_instructions}"
     ),
    ("human",
     "å½“å‰è¡Œç¨‹ï¼šä» {arrival_hub_name} åˆ° {meeting_venue_name}ã€‚"
     "å¯ç”¨æ€»æ—¶é—´ (ä»åˆ°è¾¾æ¢çº½ç®—èµ·): **{available_minutes} åˆ†é’Ÿ**ã€‚\n"
     "ä»åˆ°è¾¾ç«™å°åˆ°ä¼šè®®åœ°ç‚¹çš„äº¤é€šè€—æ—¶çº¦ä¸º {initial_commute_time} åˆ†é’Ÿã€‚\n"
     "ä»¥ä¸‹æ˜¯å¯ä¾›é€‰æ‹©çš„ã€é¡ºè·¯ä¸”æ»¡è¶³åˆæ­¥æ—¶é—´è¦æ±‚çš„ä¼ä¸šåˆ—è¡¨ï¼š{available_companies}\n"
     "**ã€å¼ºåˆ¶è§„åˆ’æŒ‡ä»¤ã€‘**ï¼šé‰´äºæ‚¨æœ‰ {available_minutes} åˆ†é’Ÿçš„å……è¶³ç©ºé—²æ—¶é—´ï¼Œå¦‚æœ 'available_companies' åˆ—è¡¨ä¸ä¸ºç©ºï¼Œ**è¯·å¿…é¡»é€‰æ‹©è‡³å°‘ 1 ä¸ªä¼ä¸šè¿›è¡Œè°ƒç ”**ï¼Œå¹¶æ ¹æ®è°ƒç ”ä»·å€¼(value_score)/æ—¶é—´æˆæœ¬(driving_time_min)åŸåˆ™ï¼Œé€‰æ‹©æœ€ä¼˜çš„ä¼ä¸šè¿›è¡Œæ’åºï¼ˆæœ€å¤š 2 ä¸ªï¼‰ã€‚"
     "è¯·è¾“å‡ºä¸€ä¸ªåŒ…å«è°ƒç ”ä¼ä¸šåç§°å’Œå»ºè®®é¡ºåºçš„ JSON åˆ—è¡¨ï¼Œä¾‹å¦‚: [{{\"name\": \"åˆ›æ–°ç§‘æŠ€ A\", \"order\": 1}}, {{...}}]ã€‚"
     )
]).partial(format_instructions=JsonOutputParser(pydantic_object=PreMeetingPlanOutput).get_format_instructions())



FINAL_REPORT_TEMPLATE = """
# âœˆï¸ {date} {origin_city} -> {destination_city} å•†åŠ¡è¡Œç¨‹

## ğŸ“„ ç”¨æˆ·/ä¼šè®®æ‘˜è¦
* **å‡ºå·®ç›®çš„ï¼š** å‚åŠ ä½äº {destination_city} çš„å•†åŠ¡ä¼šè®®ã€‚
* **ä¼šè®®åœ°ç‚¹ï¼š** {meeting_address}
* **ä¼šè®®å¼€å§‹æ—¶é—´ï¼š** {meeting_start_time}
* **å…¥ä½é…’åº—ï¼š** {hotel_address}

---

## ğŸš€ æ ¸å¿ƒäº¤é€šæ–¹æ¡ˆ (å·²é€‰å®š)
æœ¬æ¬¡è¡Œç¨‹é€‰å®šçš„äº¤é€šå·¥å…·å’Œç­æ¬¡å¦‚ä¸‹ã€‚è¿™æ˜¯æµç¨‹æ ¹æ®æ—¶é—´å’Œä»·æ ¼è®¡ç®—å‡ºçš„æœ€ä½³æ–¹æ¡ˆï¼Œ**è¯·å‹¿æ›´æ”¹**ï¼š
{transport_summary}

---

## ğŸ“… è¡Œç¨‹æ˜ç»†è¡¨ (æŒ‰æ—¶é—´é¡ºåº)
{itinerary_table_markdown}

---
### âš ï¸ å…³é”®ä¿¡æ¯ä¸æé†’
* **æœ€ç»ˆåˆ°è¾¾æ—¶é—´ï¼š** é¢„è®¡ {destination_city} å½“åœ°æ—¶é—´ **{actual_arrival_time}** åˆ°è¾¾ä¼šè®®åœ°ç‚¹ã€‚
* **æ—¶é—´è£•é‡ï¼š** æå‰ä¼šè®®å¼€å§‹æ—¶é—´ ({meeting_start_time}) çº¦ {buffer_minutes} åˆ†é’Ÿã€‚
* **ä¼šè®®å‰è°ƒç ”ï¼š** {visit_summary} 
* **é«˜å¾· API è­¦å‘Šï¼š** {error_summary}
"""